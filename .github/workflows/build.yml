name: Build & Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Cache Tizen Studio
        id: cache-tizen
        uses: actions/cache@v4
        with:
          path: |
            ~/tizen-studio
            ~/tizen-studio-data
          key: tizen-studio-5.6

      - name: Install Tizen Studio CLI
        if: steps.cache-tizen.outputs.cache-hit != 'true'
        run: |
          curl -o tizen-installer.bin https://download.tizen.org/sdk/Installer/tizen-studio_5.6/web-cli_Tizen_Studio_5.6_ubuntu-64.bin
          chmod +x tizen-installer.bin
          ./tizen-installer.bin --accept-license "$HOME/tizen-studio"

      - name: Set up Tizen CLI
        run: |
          echo "$HOME/tizen-studio/tools/ide/bin" >> $GITHUB_PATH
          echo "$HOME/tizen-studio/tools" >> $GITHUB_PATH

      - name: Create dummy signing certificate
        run: |
          # Remove stale profile data so re-creation always works
          rm -f "$HOME/tizen-studio-data/profile/profiles.xml"
          rm -rf "$HOME/tizen-studio-data/keystore/author"
          mkdir -p "$HOME/tizen-studio-data/profile"
          mkdir -p "$HOME/tizen-studio-data/keystore/author"
          tizen certificate -a MoonfinCI -p 1234 -c US -s CI -ct developer
          tizen security-profiles add -n MoonfinCI -a "$HOME/tizen-studio-data/keystore/author/author.p12" -p 1234
          tizen cli-config default.profiles.path="$HOME/tizen-studio-data/profile/profiles.xml"

      - name: Install dependencies
        run: npm install --force

      - name: Build .wgt
        run: npm run build
        env:
          TIZEN_SIGN_PROFILE: MoonfinCI

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Moonfin-Tizen-v${{ steps.version.outputs.version }}
          path: Moonfin-v${{ steps.version.outputs.version }}.wgt
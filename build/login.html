<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonfin for Tizen - Login</title>
    <link rel="stylesheet" href="css/legacy-compat.css">
    <link rel="stylesheet" href="css/login.css">
    <script src="js/tizen-adapter.js" charset="utf-8"></script>
    <script src="js/polyfills.js" charset="utf-8"></script>
    <script src="js/storage.js" charset="utf-8"></script>
    <script src="js/multi-server.js" charset="utf-8"></script>
    <script src="js/accent-color.js" charset="utf-8"></script>
    <script src="js/ajax.js" charset="utf-8"></script>
    <script src="js/keycodes.js" charset="utf-8"></script>
    <script src="js/jellyfin-api.js" charset="utf-8"></script>
    <script src="js/login.js" charset="utf-8"></script>
</head>
<body>
    <div class="container">

        <div class="logo-section">
            <img src="assets/banner-dark.png" alt="Jellyfin">
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="content-wrapper">
            
            <!-- Saved Servers Section -->
            <div class="section" id="savedServersSection" style="display: none;">
                <h2>Select Server</h2>
                <div class="user-row-container">
                    <div id="savedServerRow" class="user-row">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="button-group" style="justify-content: center; margin-top: 20px;">
                    <button id="addNewServerBtn" class="btn btn-secondary" tabindex="0">Add New Server</button>
                </div>
            </div>
            
            <div class="section" id="discoveredServersSection" style="display: none;">
                <h2>Discovered Servers</h2>
                <ul id="serverList" class="server-list">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>

            <div class="section" id="manualServerSection">
                <h2>Connect to Server</h2>
                <div class="form-group">
                    <label for="serverUrl">Server Address</label>
                    <input 
                        type="text" 
                        id="serverUrl" 
                        placeholder="192.168.1.100 or jellyfin.example.com (port auto-added)"
                        tabindex="0"
                        class="input-field"
                    >
                    <div class="button-group">
                        <button id="connectBtn" class="btn btn-primary" tabindex="0">Connect</button>
                        <button id="backToServerListBtn" class="btn btn-secondary" tabindex="0">Return to Server List</button>
                    </div>
                </div>
            </div>

            <!-- User Selection (hidden until connected) -->
            <div class="section" id="userSelection" style="display: none;">
                <div class="user-row-container">
                    <div id="userRow" class="user-row">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="button-group" style="justify-content: center; margin-top: 20px;">
                    <button id="showManualLoginBtn" class="btn btn-secondary" tabindex="0">Manual Login</button>
                    <button id="deleteServerBtn" class="btn btn-danger" tabindex="0">Delete Server</button>
                    <button id="backToServerBtn" class="btn btn-secondary" tabindex="0">Back to Server Selection</button>
                </div>
            </div>

            <!-- Manual Login (hidden until Add Account clicked) -->
            <div class="section" id="manualLoginSection" style="display: none;">
                <h2>Manual Login</h2>
                <div class="login-method-buttons">
                    <button id="useManualPasswordBtn" class="btn btn-secondary" tabindex="0" style="display: none;">Use Password</button>
                    <button id="useManualQuickConnectBtn" class="btn btn-secondary" tabindex="0" style="display: none;">Use Quick Connect</button>
                </div>
                
                <!-- Password Form -->
                <div id="manualPasswordForm" style="display: none;">
                    <div class="form-group">
                        <label for="manualUsername">Username</label>
                        <input 
                            type="text" 
                            id="manualUsername" 
                            placeholder="Enter your username"
                            tabindex="0"
                            class="input-field"
                        >
                    </div>
                    <div class="form-group">
                        <label for="manualPassword">Password</label>
                        <input 
                            type="password" 
                            id="manualPassword" 
                            placeholder="Enter your password (or leave blank if none)"
                            tabindex="0"
                            class="input-field"
                        >
                    </div>
                    <div class="button-group">
                        <button id="manualLoginBtn" class="btn btn-primary" tabindex="0">Login</button>
                        <button id="cancelManualLoginBtn" class="btn btn-secondary" tabindex="0">Back</button>
                    </div>
                </div>
                
                <!-- Quick Connect Form -->
                <div id="manualQuickConnectForm" style="display: none;">
                    <div class="quick-connect-instructions">
                        <p>To sign in, open the Jellyfin app on your phone or computer and enter this code:</p>
                        <div id="manualQuickConnectCode" class="quick-connect-code">------</div>
                        <div id="manualQuickConnectStatus" class="quick-connect-status">Waiting for authentication...</div>
                    </div>
                    <div class="button-group">
                        <button id="cancelManualQuickConnectBtn" class="btn btn-secondary" tabindex="0">Back</button>
                    </div>
                </div>
            </div>

            <!-- Login Form (hidden until user selected) -->
            <div class="section" id="loginForm" style="display: none;">
                <div class="login-method-buttons">
                    <button id="useQuickConnectBtn" class="btn btn-secondary" tabindex="0" style="display: none;">Use Quick Connect</button>
                    <button id="usePasswordBtn" class="btn btn-secondary" tabindex="0" style="display: none;">Use Password</button>
                </div>
                
                <!-- Password Login -->
                <div id="passwordForm" style="display: none;">
                    <h2>Enter Password</h2>
                    <div class="selected-user-info">
                        <img id="selectedUserAvatar" class="selected-user-avatar" src="" alt="">
                        <span id="selectedUserName" class="selected-user-name"></span>
                    </div>
                    <div class="form-group">
                        <input 
                            type="password" 
                            id="password" 
                            placeholder="Enter your password (or leave blank if none)"
                            tabindex="0"
                            class="input-field"
                        >
                    </div>
                    <div class="button-group">
                        <button id="loginBtn" class="btn btn-primary" tabindex="0">Login</button>
                        <button id="cancelLoginBtn" class="btn btn-secondary" tabindex="0">Back</button>
                    </div>
                </div>

                <!-- Quick Connect -->
                <div id="quickConnectForm" style="display: none;">
                    <h2>Quick Connect</h2>
                    <div class="selected-user-info">
                        <img id="qcSelectedUserAvatar" class="selected-user-avatar" src="" alt="">
                        <span id="qcSelectedUserName" class="selected-user-name"></span>
                    </div>
                    <div class="quick-connect-instructions">
                        <p>To sign in, open the Jellyfin app on your phone or computer and enter this code:</p>
                        <div id="quickConnectCode" class="quick-connect-code">------</div>
                        <div id="quickConnectStatus" class="quick-connect-status">Waiting for authentication...</div>
                    </div>
                    <div class="button-group">
                        <button id="cancelQuickConnectBtn" class="btn btn-secondary" tabindex="0">Back</button>
                    </div>
                </div>
            </div>

        </div>

        <div class="helper-text">
            <p>Need help? Make sure your Jellyfin server is running and accessible on your network.</p>
            <p>Use the remote to navigate and press OK to select.</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: #1a1a1a; padding: 50px 60px; border-radius: 12px; max-width: 700px; border: 3px solid var(--accent-color); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <h2 id="confirmTitle" style="margin-top: 0; color: #fff; font-size: 32px; margin-bottom: 25px; font-weight: 600;">Confirm Action</h2>
            <p id="confirmMessage" style="color: rgba(255,255,255,0.9); font-size: 22px; margin-bottom: 40px; line-height: 1.6;"></p>
            <div style="display: flex; gap: 20px; justify-content: flex-end;">
                <button id="confirmCancel" class="btn btn-secondary" tabindex="0" style="min-width: 160px; font-size: 20px; padding: 15px 30px; border: 3px solid transparent;">Cancel</button>
                <button id="confirmOk" class="btn btn-danger" tabindex="0" style="min-width: 160px; font-size: 20px; padding: 15px 30px; border: 3px solid transparent;">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Confirmation modal helper
        var confirmationState = {
            modal: null,
            callback: null,
            isOpen: false
        };

        function showConfirmation(title, message, onConfirm) {
            var modal = document.getElementById('confirmationModal');
            var titleEl = document.getElementById('confirmTitle');
            var messageEl = document.getElementById('confirmMessage');
            var cancelBtn = document.getElementById('confirmCancel');
            var okBtn = document.getElementById('confirmOk');

            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmationState.callback = onConfirm;
            confirmationState.isOpen = true;

            modal.style.display = 'flex';

            // Create handler functions with proper closure
            var handleCancel = function() {
                if (!confirmationState.isOpen) return;
                confirmationState.isOpen = false;
                modal.style.display = 'none';
                if (confirmationState.callback) {
                    confirmationState.callback(false);
                }
            };

            var handleOk = function() {
                if (!confirmationState.isOpen) return;
                confirmationState.isOpen = false;
                modal.style.display = 'none';
                if (confirmationState.callback) {
                    confirmationState.callback(true);
                }
            };

            // Remove any previous event listeners
            var newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            cancelBtn = newCancelBtn;
            document.getElementById('confirmCancel').addEventListener('click', handleCancel);

            var newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            okBtn = newOkBtn;
            document.getElementById('confirmOk').addEventListener('click', handleOk);

            // Remove old keyboard handler
            document.removeEventListener('keydown', confirmationState.keyHandler);

            // Create new keyboard handler
            confirmationState.keyHandler = function(e) {
                if (!confirmationState.isOpen) return;

                var currentCancelBtn = document.getElementById('confirmCancel');
                var currentOkBtn = document.getElementById('confirmOk');

                // BACK (Tizen: 10009), Backspace (8), or ESC (27)
                if (e.keyCode === KeyCodes.BACK || e.keyCode === 8 || e.keyCode === 27) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleCancel();
                    return;
                }

                // ENTER (13)
                if (e.keyCode === 13) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (document.activeElement === currentOkBtn) {
                        handleOk();
                    } else if (document.activeElement === currentCancelBtn) {
                        handleCancel();
                    } else {
                        // If nothing focused, default to Cancel for safety
                        handleCancel();
                    }
                    return;
                }

                // LEFT (37) / RIGHT (39) to move between buttons
                if (e.keyCode === 37 || e.keyCode === 39) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (document.activeElement === currentOkBtn) {
                        currentCancelBtn.focus();
                        currentCancelBtn.style.borderColor = 'var(--accent-color)';
                        currentOkBtn.style.borderColor = 'transparent';
                    } else {
                        currentOkBtn.focus();
                        currentOkBtn.style.borderColor = 'var(--accent-color)';
                        currentCancelBtn.style.borderColor = 'transparent';
                    }
                    return;
                }
            };

            document.addEventListener('keydown', confirmationState.keyHandler);

            // Focus the Cancel button by default (safer for destructive actions)
            setTimeout(function() {
                var cancelBtn = document.getElementById('confirmCancel');
                cancelBtn.focus();
                cancelBtn.style.borderColor = 'var(--accent-color)';
            }, 100);
        }

        function closeConfirmation() {
            var modal = document.getElementById('confirmationModal');
            confirmationState.isOpen = false;
            modal.style.display = 'none';
            if (confirmationState.callback) {
                confirmationState.callback(false);
            }
        }
        // Handle input focus to scroll into view when keyboard appears
        document.addEventListener('DOMContentLoaded', function() {
            var inputs = document.querySelectorAll('.input-field');
            
            inputs.forEach(function(input) {
                input.addEventListener('focus', function() {
                    var self = this;
                    // Delay to allow keyboard to appear
                    setTimeout(function() {
                        // Scroll the input into view
                        self.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300);
                });
            });
        });

        // Tizen specific keyboard handling
        document.addEventListener('keydown', function(evt) {
            evt = evt || window.event;
            
            // Handle back button on Tizen remote
            if (evt.keyCode === KeyCodes.BACK) {
                webOS.platformBack();
                return;
            }
            
            var activeElement = document.activeElement;
            
            // Handle user row horizontal navigation
            if (activeElement && activeElement.classList.contains('user-card')) {
                var userCards = Array.from(document.querySelectorAll('.user-card'));
                var currentIndex = userCards.indexOf(activeElement);
                
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (currentIndex > 0) {
                        userCards[currentIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (currentIndex < userCards.length - 1) {
                        userCards[currentIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 40) { // Down arrow - go to buttons
                    evt.preventDefault();
                    var manualLoginBtn = document.getElementById('showManualLoginBtn');
                    if (manualLoginBtn && manualLoginBtn.offsetParent !== null) {
                        manualLoginBtn.focus();
                    } else {
                        var backBtn = document.getElementById('backToServerBtn');
                        if (backBtn && backBtn.offsetParent !== null) {
                            backBtn.focus();
                        }
                    }
                    return;
                }
            }
            
            // Handle bottom buttons navigation (Manual Login and Back to Server)
            var bottomButtons = [
                document.getElementById('showManualLoginBtn'),
                document.getElementById('backToServerBtn')
            ].filter(function(btn) { return btn && btn.offsetParent !== null; });
            
            var bottomButtonIndex = bottomButtons.indexOf(activeElement);
            if (bottomButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (bottomButtonIndex > 0) {
                        bottomButtons[bottomButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (bottomButtonIndex < bottomButtons.length - 1) {
                        bottomButtons[bottomButtonIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow - go to user row
                    evt.preventDefault();
                    var userCards = document.querySelectorAll('.user-card');
                    if (userCards.length > 0) {
                        userCards[0].focus();
                    }
                    // If no user cards, stay on button
                    return;
                }
            }
            
            // Handle password/Quick Connect method buttons (horizontal)
            var methodButtons = [
                document.getElementById('usePasswordBtn'),
                document.getElementById('useQuickConnectBtn')
            ].filter(function(btn) { return btn && btn.offsetParent !== null; });
            
            var methodButtonIndex = methodButtons.indexOf(activeElement);
            if (methodButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (methodButtonIndex > 0) {
                        methodButtons[methodButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (methodButtonIndex < methodButtons.length - 1) {
                        methodButtons[methodButtonIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 40) { // Down arrow - go to form below
                    evt.preventDefault();
                    var passwordInput = document.getElementById('password');
                    if (passwordInput && passwordInput.offsetParent !== null) {
                        passwordInput.focus();
                    }
                    return;
                }
            }
            
            // Handle manual login method buttons (horizontal)
            var manualMethodButtons = [
                document.getElementById('useManualPasswordBtn'),
                document.getElementById('useManualQuickConnectBtn')
            ].filter(function(btn) { return btn && btn.offsetParent !== null; });
            
            var manualMethodButtonIndex = manualMethodButtons.indexOf(activeElement);
            if (manualMethodButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (manualMethodButtonIndex > 0) {
                        manualMethodButtons[manualMethodButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (manualMethodButtonIndex < manualMethodButtons.length - 1) {
                        manualMethodButtons[manualMethodButtonIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 40) { // Down arrow - go to form below
                    evt.preventDefault();
                    var manualUsernameInput = document.getElementById('manualUsername');
                    if (manualUsernameInput && manualUsernameInput.offsetParent !== null) {
                        manualUsernameInput.focus();
                    }
                    return;
                }
            }
            
            // Handle manual login form fields (vertical navigation)
            if (activeElement && activeElement.id === 'manualUsername') {
                if (evt.keyCode === 40) { // Down arrow
                    evt.preventDefault();
                    var manualPassword = document.getElementById('manualPassword');
                    if (manualPassword && manualPassword.offsetParent !== null) {
                        manualPassword.focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow
                    evt.preventDefault();
                    var useManualPasswordBtn = document.getElementById('useManualPasswordBtn');
                    var useManualQuickConnectBtn = document.getElementById('useManualQuickConnectBtn');
                    var showManualLoginBtn = document.getElementById('showManualLoginBtn');
                    if (useManualQuickConnectBtn && useManualQuickConnectBtn.offsetParent !== null) {
                        useManualQuickConnectBtn.focus();
                    } else if (useManualPasswordBtn && useManualPasswordBtn.offsetParent !== null) {
                        useManualPasswordBtn.focus();
                    } else if (showManualLoginBtn && showManualLoginBtn.offsetParent !== null) {
                        showManualLoginBtn.focus();
                    }
                    return;
                }
            }
            
            if (activeElement && activeElement.id === 'manualPassword') {
                if (evt.keyCode === 40) { // Down arrow
                    evt.preventDefault();
                    var manualLoginBtn = document.getElementById('manualLoginBtn');
                    if (manualLoginBtn && manualLoginBtn.offsetParent !== null) {
                        manualLoginBtn.focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow
                    evt.preventDefault();
                    var manualUsername = document.getElementById('manualUsername');
                    if (manualUsername && manualUsername.offsetParent !== null) {
                        manualUsername.focus();
                    }
                    return;
                }
            }
            
            // Handle manual login buttons (horizontal)
            var manualLoginButtons = [
                document.getElementById('manualLoginBtn'),
                document.getElementById('cancelManualLoginBtn')
            ].filter(function(btn) { return btn && btn.offsetParent !== null; });
            
            var manualLoginButtonIndex = manualLoginButtons.indexOf(activeElement);
            if (manualLoginButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (manualLoginButtonIndex > 0) {
                        manualLoginButtons[manualLoginButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (manualLoginButtonIndex < manualLoginButtons.length - 1) {
                        manualLoginButtons[manualLoginButtonIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow - go to password field
                    evt.preventDefault();
                    var manualPassword = document.getElementById('manualPassword');
                    if (manualPassword && manualPassword.offsetParent !== null) {
                        manualPassword.focus();
                    }
                    return;
                }
            }
            
            // Handle manual Quick Connect back button (should navigate up to method buttons)
            if (activeElement && activeElement.id === 'cancelManualQuickConnectBtn') {
                if (evt.keyCode === 38) { // Up arrow
                    evt.preventDefault();
                    var useManualPasswordBtn = document.getElementById('useManualPasswordBtn');
                    var useManualQuickConnectBtn = document.getElementById('useManualQuickConnectBtn');
                    if (useManualPasswordBtn && useManualPasswordBtn.offsetParent !== null) {
                        useManualPasswordBtn.focus();
                    } else if (useManualQuickConnectBtn && useManualQuickConnectBtn.offsetParent !== null) {
                        useManualQuickConnectBtn.focus();
                    }
                    return;
                }
            }
            
            // Handle server URL input field
            if (activeElement && activeElement.id === 'serverUrl') {
                if (evt.keyCode === 40) { // Down arrow - go to Connect button
                    evt.preventDefault();
                    var connectBtn = document.getElementById('connectBtn');
                    if (connectBtn && connectBtn.offsetParent !== null) {
                        connectBtn.focus();
                    }
                    return;
                }
            }
            
            // Handle server connection buttons (horizontal)
            var serverButtons = [
                document.getElementById('connectBtn'),
                document.getElementById('discoverBtn')
            ].filter(function(btn) { return btn && btn.offsetParent !== null; });
            
            var serverButtonIndex = serverButtons.indexOf(activeElement);
            if (serverButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (serverButtonIndex > 0) {
                        serverButtons[serverButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (serverButtonIndex < serverButtons.length - 1) {
                        serverButtons[serverButtonIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow - go back to input
                    evt.preventDefault();
                    var serverUrl = document.getElementById('serverUrl');
                    if (serverUrl && serverUrl.offsetParent !== null) {
                        serverUrl.focus();
                    }
                    return;
                }
            }
            
            // Handle password form buttons (horizontal)
            var passwordButtons = [
                document.getElementById('loginBtn'),
                document.getElementById('cancelLoginBtn')
            ].filter(function(btn) { return btn && btn.offsetParent !== null; });
            
            var passwordButtonIndex = passwordButtons.indexOf(activeElement);
            if (passwordButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (passwordButtonIndex > 0) {
                        passwordButtons[passwordButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (passwordButtonIndex < passwordButtons.length - 1) {
                        passwordButtons[passwordButtonIndex + 1].focus();
                    }
                    return;
                }
            }
            
            // Handle password form input field
            if (activeElement && activeElement.id === 'password') {
                if (evt.keyCode === 40) { // Down arrow
                    evt.preventDefault();
                    var loginBtn = document.getElementById('loginBtn');
                    if (loginBtn && loginBtn.offsetParent !== null) {
                        loginBtn.focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow
                    evt.preventDefault();
                    var usePasswordBtn = document.getElementById('usePasswordBtn');
                    var useQuickConnectBtn = document.getElementById('useQuickConnectBtn');
                    if (useQuickConnectBtn && useQuickConnectBtn.offsetParent !== null) {
                        useQuickConnectBtn.focus();
                    } else if (usePasswordBtn && usePasswordBtn.offsetParent !== null) {
                        usePasswordBtn.focus();
                    }
                    return;
                }
            }
            
            // Handle password button navigation for vertical movement
            var passwordButtonIndex = passwordButtons.indexOf(activeElement);
            if (passwordButtonIndex !== -1) {
                if (evt.keyCode === 37) { // Left arrow
                    evt.preventDefault();
                    if (passwordButtonIndex > 0) {
                        passwordButtons[passwordButtonIndex - 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 39) { // Right arrow
                    evt.preventDefault();
                    if (passwordButtonIndex < passwordButtons.length - 1) {
                        passwordButtons[passwordButtonIndex + 1].focus();
                    }
                    return;
                } else if (evt.keyCode === 38) { // Up arrow - go to password field
                    evt.preventDefault();
                    var passwordInput = document.getElementById('password');
                    if (passwordInput && passwordInput.offsetParent !== null) {
                        passwordInput.focus();
                    }
                    return;
                }
            }
            
            // Handle Quick Connect cancel button (should navigate up to method buttons)
            if (activeElement && activeElement.id === 'cancelQuickConnectBtn') {
                if (evt.keyCode === 38) { // Up arrow
                    evt.preventDefault();
                    var usePasswordBtn = document.getElementById('usePasswordBtn');
                    var useQuickConnectBtn = document.getElementById('useQuickConnectBtn');
                    if (usePasswordBtn && usePasswordBtn.offsetParent !== null) {
                        usePasswordBtn.focus();
                    } else if (useQuickConnectBtn && useQuickConnectBtn.offsetParent !== null) {
                        useQuickConnectBtn.focus();
                    }
                    return;
                }
            }
            
            // General vertical navigation for other elements
            var focusableElements = 'input:not([disabled]):not([type="password"]), button:not([disabled]), .server-item, .user-card';
            var focusable = Array.from(document.querySelectorAll(focusableElements))
                .filter(function(el) {
                    return el.offsetWidth > 0 && el.offsetHeight > 0 && el.offsetParent !== null;
                });
            
            var currentIndex = focusable.indexOf(activeElement);
            
            if (evt.keyCode === 38) { // Up arrow
                evt.preventDefault();
                if (currentIndex > 0) {
                    focusable[currentIndex - 1].focus();
                }
            } else if (evt.keyCode === 40) { // Down arrow
                evt.preventDefault();
                if (currentIndex < focusable.length - 1) {
                    focusable[currentIndex + 1].focus();
                }
            }
        });
    </script>
</body>
</html>

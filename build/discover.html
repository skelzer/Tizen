<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover - Jellyseerr</title>
    <script>
        // Create a visible log div immediately
        window.logToScreen = function(msg) {
            var logDiv = document.getElementById('screenLog');
            if (!logDiv) {
                logDiv = document.createElement('div');
                logDiv.id = 'screenLog';
                logDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#000;color:#0f0;font-family:monospace;font-size:14px;padding:10px;z-index:999999;max-height:50%;overflow-y:auto;white-space:pre-wrap;';
                document.body ? document.body.appendChild(logDiv) : document.addEventListener('DOMContentLoaded', function() { document.body.appendChild(logDiv); });
            }
            logDiv.innerHTML += msg + '<br>';
        };
        window.onerror = function(msg, url, line) {
            window.logToScreen('ERROR: ' + msg + ' at line ' + line);
            return false;
        };
        window.logToScreen('Page starting...');
    </script>
    <style>
        #debugPanel {
            display: none; /* Hide the old debug panel */
        }
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: auto;
            z-index: 999999;
            border: 1px solid #0f0;
        }
        #debugPanel .error { color: #f00; }
        #debugPanel .warn { color: #ff0; }
    </style>
    <script>
        (function() {
            var logs = [];
            var panel = null;
            function createPanel() {
                panel = document.createElement('div');
                panel.id = 'debugPanel';
                panel.innerHTML = '<b>DEBUG LOG</b><br>';
                document.body.appendChild(panel);
            }
            function addLog(type, args) {
                var msg = Array.prototype.slice.call(args).map(function(a) {
                    if (typeof a === 'object') {
                        try { return JSON.stringify(a); } catch(e) { return String(a); }
                    }
                    return String(a);
                }).join(' ');
                logs.push({ type: type, msg: msg, time: new Date().toLocaleTimeString() });
                if (logs.length > 100) logs.shift();
                if (panel) {
                    var div = document.createElement('div');
                    div.className = type;
                    div.textContent = '[' + logs[logs.length-1].time + '] ' + msg;
                    panel.appendChild(div);
                    panel.scrollTop = panel.scrollHeight;
                }
            }
            var origLog = console.log, origError = console.error, origWarn = console.warn;
            console.log = function() { origLog.apply(console, arguments); addLog('log', arguments); };
            console.error = function() { origError.apply(console, arguments); addLog('error', arguments); };
            console.warn = function() { origWarn.apply(console, arguments); addLog('warn', arguments); };
            window.onerror = function(msg, url, line, col, error) { 
                addLog('error', ['UNCAUGHT: ' + msg + ' at ' + url + ':' + line + ':' + col]); 
                if (error && error.stack) addLog('error', ['Stack: ' + error.stack]);
                return true; // Prevent default error handling
            };
            window.onunhandledrejection = function(e) {
                addLog('error', ['UNHANDLED PROMISE: ' + (e.reason ? (e.reason.message || e.reason) : 'unknown')]);
            };
            // Intercept redirects
            var origHref = Object.getOwnPropertyDescriptor(window.location.__proto__, 'href');
            // Can't override location.href easily, but log when it would happen
            document.addEventListener('DOMContentLoaded', function() { createPanel(); console.log('DOM Ready'); });
            console.log('Debug panel initialized (v2)');
        })();
    </script>
    <link rel="stylesheet" href="css/legacy-compat.css">
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/browse.css">
    <link rel="stylesheet" href="css/discover.css">
    <link rel="stylesheet" href="css/settings.css">
    <script src="js/tizen-adapter.js" charset="utf-8"></script>
    <script>window.logToScreen('1. tizen-adapter loaded');</script>
    <script src="js/polyfills.js" charset="utf-8"></script>
    <script>window.logToScreen('2. polyfills loaded');</script>
    <script src="js/storage.js" charset="utf-8"></script>
    <script>window.logToScreen('3. storage loaded: ' + (typeof storage !== 'undefined'));</script>
    <script src="js/accent-color.js" charset="utf-8"></script>
    <script>window.logToScreen('4. accent-color loaded');</script>
    <script src="js/ajax.js" charset="utf-8"></script>
    <script>window.logToScreen('5. ajax loaded');</script>
    <script src="js/keycodes.js" charset="utf-8"></script>
    <script>window.logToScreen('6. keycodes loaded');</script>
    <script src="js/jellyfin-api.js" charset="utf-8"></script>
    <script>window.logToScreen('7. jellyfin-api loaded: ' + (typeof JellyfinAPI !== 'undefined'));</script>
    <script src="js/image-helper.js" charset="utf-8"></script>
    <script>window.logToScreen('8. image-helper loaded');</script>
    <script src="js/jellyseerr-models.js" charset="utf-8"></script>
    <script>window.logToScreen('9. jellyseerr-models loaded');</script>
    <script src="js/jellyseerr-api.js" charset="utf-8"></script>
    <script>window.logToScreen('10. jellyseerr-api loaded: ' + (typeof JellyseerrAPI !== 'undefined'));</script>
    <script src="js/jellyseerr-preferences.js" charset="utf-8"></script>
    <script>window.logToScreen('11. jellyseerr-preferences loaded');</script>
    <script src="js/multi-server.js" charset="utf-8"></script>
    <script>window.logToScreen('12. multi-server loaded');</script>
    <script src="js/connection-pool.js" charset="utf-8"></script>
    <script>window.logToScreen('13. connection-pool loaded');</script>
    <script src="js/navbar.js" charset="utf-8"></script>
    <script>window.logToScreen('14. navbar loaded');</script>
    <script src="js/discover.js" charset="utf-8"></script>
    <script>window.logToScreen('15. discover.js loaded: ' + (typeof DiscoverController !== 'undefined'));</script>
    <script>window.logToScreen('=== ALL SCRIPTS DONE ===');</script>
</head>
<body>
    <script>console.log('=== DISCOVER.HTML BODY LOADED ===');</script>
    <!-- Global backdrop for page background -->
    <div id="globalBackdrop" class="global-backdrop">
        <img id="globalBackdropImage" class="global-backdrop-image" src="" alt="" style="display: none;">
        <div class="global-backdrop-overlay"></div>
    </div>
    
    <!-- Navbar will be loaded by navbar.js -->

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Split View Detail Section -->
        <div id="detailSection" class="detail-section" style="display: none;">
            <div class="detail-content-wrapper">
                <h2 id="detailTitle" class="detail-title"></h2>
                <div id="detailInfoRow" class="detail-info-row"></div>
                <p id="detailSummary" class="detail-summary"></p>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading content...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;">
            <p id="errorText"></p>
            <button class="btn-secondary" id="retryBtn">Retry</button>
        </div>

        <!-- Rows Container -->
        <div class="rows-container" id="rowsContainer">
            <!-- Trending Row -->
            <div class="content-row" id="trendingRow" data-row-id="trending">
                <h2 class="row-title">Trending Now</h2>
                <div class="row-items" id="trendingItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Popular Movies Row -->
            <div class="content-row" id="popularMoviesRow" data-row-id="popularMovies">
                <h2 class="row-title">Popular Movies</h2>
                <div class="row-items" id="popularMoviesItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Popular TV Shows Row -->
            <div class="content-row" id="popularTvRow" data-row-id="popularTv">
                <h2 class="row-title">Popular TV Shows</h2>
                <div class="row-items" id="popularTvItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Genre Movies Row -->
            <div class="content-row" id="genreMoviesRow" data-row-id="genreMovies">
                <h2 class="row-title">Browse Movies by Genre</h2>
                <div class="row-items" id="genreMoviesItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Genre TV Shows Row -->
            <div class="content-row" id="genreTvRow" data-row-id="genreTv">
                <h2 class="row-title">Browse TV Shows by Genre</h2>
                <div class="row-items" id="genreTvItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Browse by Studio Row -->
            <div class="content-row" id="studiosRow" data-row-id="studios">
                <h2 class="row-title">Browse by Studio</h2>
                <div class="row-items" id="studiosItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Browse by Network Row -->
            <div class="content-row" id="networksRow" data-row-id="networks">
                <h2 class="row-title">Browse by Network</h2>
                <div class="row-items" id="networksItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Upcoming Movies Row -->
            <div class="content-row" id="upcomingMoviesRow" data-row-id="upcomingMovies">
                <h2 class="row-title">Upcoming Movies</h2>
                <div class="row-items" id="upcomingMoviesItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Upcoming TV Shows Row -->
            <div class="content-row" id="upcomingTvRow" data-row-id="upcomingTv">
                <h2 class="row-title">Upcoming TV Shows</h2>
                <div class="row-items" id="upcomingTvItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- My Requests Row -->
            <div class="content-row" id="requestsRow" data-row-id="requests">
                <h2 class="row-title">My Requests</h2>
                <div class="row-items" id="requestsItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Required Modal -->
    <div id="authRequiredModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Authentication Required</h2>
            <p class="modal-description">You need to authenticate with Jellyseerr to view this content.</p>
            <p class="modal-description">Would you like to authenticate now?</p>
            
            <div class="modal-actions">
                <button class="btn-primary" id="authNowBtn" tabindex="0">Authenticate Now</button>
                <button class="btn-secondary" id="authCancelBtn" tabindex="0">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Connection Required Message -->
    <div id="connectionRequired" class="connection-required" style="display: none;">
        <div class="connection-message">
            <h2>üîå Jellyseerr Not Connected</h2>
            <p>To use the Discover feature, please connect to your Jellyseerr server in Settings.</p>
            <div class="connection-actions">
                <button class="btn-primary" id="goToSettingsBtn" tabindex="0">Go to Settings</button>
                <button class="btn-secondary" id="goBackBtn" tabindex="0">Go Back</button>
            </div>
        </div>
    </div>

    <!-- Authentication Required Message -->
    <div id="authRequired" class="connection-required" style="display: none;">
        <div class="connection-message">
            <h2>üîê Authentication Required</h2>
            <p>Please authenticate with Jellyseerr in Settings to access Discover content.</p>
            <div class="connection-actions">
                <button class="btn-primary" id="goToSettingsForAuthBtn" tabindex="0">Go to Settings</button>
                <button class="btn-secondary" id="goBackFromAuthBtn" tabindex="0">Go Back</button>
            </div>
        </div>
    </div>
</body>
</html>
